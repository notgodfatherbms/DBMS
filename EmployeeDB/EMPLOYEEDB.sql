CREATE DATABASE companyDB;
USE companyDB;
CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL DECIMAL(10, 2),
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(50),
    PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10, 2),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);

INSERT INTO DEPT VALUES
(10, 'HR', 'Bengaluru'),
(20, 'IT', 'Hyderabad'),
(30, 'Finance', 'Mysuru'),
(40, 'Admin', 'Chennai'),
(50, 'Research', 'Bengaluru'),
(60, 'Marketing', 'Pune');

INSERT INTO EMPLOYEE VALUES
(101, 'Arun', 201, '2020-03-15', 50000, 10),
(102, 'Bina', 201, '2021-06-01', 60000, 20),
(103, 'Chirag', 202, '2019-09-23', 55000, 30),
(104, 'Deepa', 202, '2022-02-12', 62000, 40),
(105, 'Eshan', 203, '2020-11-05', 70000, 50),
(106, 'Farah', 203, '2018-01-18', 68000, 60);

INSERT INTO PROJECT VALUES
(1001, 'Payroll System', 'Bengaluru'),
(1002, 'ERP Implementation', 'Hyderabad'),
(1003, 'Budget Control', 'Mysuru'),
(1004, 'Recruitment Portal', 'Chennai'),
(1005, 'AI Research', 'Bengaluru'),
(1006, 'Ad Campaign', 'Pune');

INSERT INTO ASSIGNED_TO VALUES
(101, 1001, 'Analyst'),
(102, 1002, 'Developer'),
(103, 1003, 'Tester'),
(104, 1004, 'Manager'),
(105, 1005, 'Researcher'),
(106, 1006, 'Coordinator');

INSERT INTO INCENTIVES VALUES
(101, '2024-01-15', 2000),
(103, '2024-02-10', 2500),
(105, '2024-03-05', 3000),
(106, '2024-04-01', 1500),
(102, '2024-05-10', 1800);

SELECT DISTINCT A.EMPNO
FROM ASSIGNED_TO A
JOIN PROJECT P ON A.PNO = P.PNO
WHERE P.PLOC IN ('Bengaluru', 'Hyderabad', 'Mysuru');

SELECT EMPNO
FROM EMPLOYEE
WHERE EMPNO NOT IN (SELECT EMPNO FROM INCENTIVES);

SELECT E.EMPNO, E.ENAME, D.DNAME, D.DLOC, P.PLOC, A.JOB_ROLE
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
JOIN PROJECT P ON A.PNO = P.PNO
WHERE D.DLOC = P.PLOC;

SELECT e.ENAME AS ManagerName, COUNT(m.EMPNO) AS NumEmployees
FROM EMPLOYEE e
JOIN EMPLOYEE m ON e.EMPNO = m.MGR_NO
GROUP BY e.ENAME
HAVING COUNT(m.EMPNO) = (
    SELECT MAX(CountEmp)
    FROM (
        SELECT COUNT(MGR_NO) AS CountEmp
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) AS Temp
);

SELECT e.ENAME AS ManagerName
FROM EMPLOYEE e
WHERE e.EMPNO IN (
    SELECT DISTINCT MGR_NO
    FROM EMPLOYEE
    WHERE MGR_NO IS NOT NULL
)
AND e.SAL > (
    SELECT AVG(SAL)
    FROM EMPLOYEE
    WHERE MGR_NO = e.EMPNO
);


SELECT d.DNAME, e.ENAME AS SecondTopManager
FROM EMPLOYEE e
JOIN DEPT d ON e.DEPTNO = d.DEPTNO
WHERE e.MGR_NO IN (
    SELECT EMPNO
    FROM EMPLOYEE
    WHERE MGR_NO IS NULL
);

INSERT INTO INCENTIVES VALUES
(102, '2024-01-12', 2500),
(103, '2024-01-22', 1800);

SELECT EMPNO, INCENTIVE_AMOUNT
FROM INCENTIVES
WHERE MONTH(INCENTIVE_DATE) = 1 AND YEAR(INCENTIVE_DATE) = 2024
ORDER BY INCENTIVE_AMOUNT DESC
LIMIT 1 OFFSET 1;


SELECT e.ENAME AS EmployeeName, m.ENAME AS ManagerName, d.DNAME
FROM EMPLOYEE e
JOIN EMPLOYEE m ON e.MGR_NO = m.EMPNO
JOIN DEPT d ON e.DEPTNO = d.DEPTNO
WHERE e.DEPTNO = m.DEPTNO;


INSERT INTO EMPLOYEE VALUES
(201, 'Kiran', NULL, '2017-01-01', 90000, 10),
(202, 'Leela', NULL, '2016-05-15', 95000, 30),
(203, 'Manoj', NULL, '2018-08-20', 92000, 50);



SELECT DISTINCT MGR_NO FROM EMPLOYEE;




